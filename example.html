<div class="inline-drawer">
    <div class="inline-drawer-toggle inline-drawer-header">
        <b>Image Gen Kazuma</b>
        <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
    </div>

    <!-- THIS WRAPPER IS NEEDED FOR THE DRAWER TO OPEN/CLOSE -->
    <div class="inline-drawer-content">

        <!-- MODERN SETTINGS CONTAINER -->
        <div class="kazuma-settings">

            <!-- Group 1: Main Switches -->
            <div class="kazuma-group">
                <label class="kazuma-row" title="Turn the extension on/off">
                    <span><i class="fa-solid fa-power-off"></i> Enable Extension</span>
                    <input type="checkbox" id="kazuma_enable" />
                </label>
                <label class="kazuma-row" title="Fixes lag by compressing images">
                    <span><i class="fa-solid fa-compress"></i> Compress Images (Fix Lag)</span>
                    <input type="checkbox" id="kazuma_compress" />
                </label>
                <label class="kazuma-row" title="Show prompt popup for editing before generation">
                    <span><i class="fa-solid fa-bug"></i> Diagnostic Mode</span>
                    <input type="checkbox" id="kazuma_debug" />
                </label>
            </div>

            <!-- Group 2: Automation & Prompting -->
            <div class="kazuma-group">
                <div class="kazuma-header"><i class="fa-solid fa-robot"></i> Automation</div>

                <label class="kazuma-row">
                    <span>Auto-Generate</span>
                    <input type="checkbox" id="kazuma_auto_enable" />
                </label>

                <div class="kazuma-row">
                    <span>Every X replies:</span>
                    <input type="number" id="kazuma_auto_freq" class="text_pole" style="width: 60px" min="1" value="1"/>
                </div>

                <hr style="opacity:0.2; margin: 10px 0;">

                <div class="kazuma-sub-label">Prompt Generator Preset</div>

                <select id="kazuma_profile_strategy" class="text_pole" style="width:100%; margin-bottom: 5px;">
                    <option value="current">Use Current Active Preset</option>
                    <option value="specific">Use Specific Preset...</option>
                </select>

                <!-- 1. Specific Profile List (Shown ONLY if 'specific') -->
                <select id="kazuma_profile" class="text_pole" style="width:100%; display:none;"></select>

                <!-- 2. NEW: Prompt Builder (Shown ONLY if 'current') -->
                <div id="kazuma_prompt_builder" style="display:none; background:rgba(0,0,0,0.2); padding:10px; border-radius:5px; margin-top:5px; border-left: 2px solid var(--smart-text-color);">
                    <div class="kazuma-sub-label" style="margin-top:0;">Model Style (Format)</div>
                    <select id="kazuma_prompt_style" class="text_pole" style="width:100%; margin-bottom:8px;">
                        <option value="standard">Standard (Descriptive)</option>
                        <option value="illustrious">Illustrious / Pony (Booru Tags)</option>
                        <option value="sdxl">SDXL / Realistic (Natural Prose)</option>
                    </select>

                    <div class="kazuma-sub-label" style="margin-top:0;">Camera Perspective</div>
                    <select id="kazuma_prompt_persp" class="text_pole" style="width:100%; margin-bottom:8px;">
                        <option value="scene">Cinematic Scene (Environmental)</option>
                        <option value="pov">First Person (POV)</option>
                        <option value="character">Character Focus (Portrait)</option>
                    </select>

                    <div class="kazuma-sub-label" style="margin-top:0;">Extra Instructions</div>
                    <input type="text" id="kazuma_prompt_extra" class="text_pole" style="width:100%" placeholder="e.g. moody lighting, dark atmosphere...">
                </div>
            </div>

            <!-- Group 3: ComfyUI Connection -->
            <div class="kazuma-group">
                <div class="kazuma-header"><i class="fa-solid fa-link"></i> ComfyUI Server</div>

                <div style="display:flex; gap: 5px; margin-bottom: 10px;">
                    <input type="text" id="kazuma_url" class="text_pole" value="http://127.0.0.1:8188" placeholder="API URL" style="flex:1;" />
                    <button id="kazuma_test_btn" class="menu_button" title="Test Connection"><i class="fa-solid fa-wifi"></i></button>
                </div>

                <div class="kazuma-sub-label">Active Workflow</div>
                <div style="display:flex; gap:5px;">
                    <select id="kazuma_workflow_list" class="text_pole" style="flex:1"></select>
                    <button id="kazuma_new_workflow" class="menu_button fa-solid fa-plus" title="New"></button>
                    <button id="kazuma_edit_workflow" class="menu_button fa-solid fa-pen" title="Edit"></button>
                    <button id="kazuma_delete_workflow" class="menu_button fa-solid fa-trash" title="Delete"></button>
                </div>
            </div>

            <!-- Group 4: Image Editing -->
            <div class="kazuma-group">
                <div class="kazuma-header"><i class="fa-solid fa-wand-magic-sparkles"></i> Image Editing</div>
                
                <div class="kazuma-row">
                    <span>Mode</span>
                    <select id="kazuma_mode" class="text_pole">
                        <option value="generate">Generate (Text-to-Image)</option>
                        <option value="edit">Edit (Image-to-Image)</option>
                    </select>
                </div>
                
                <div id="kazuma_edit_controls" style="display:none; margin-top:10px;">
                    <div class="kazuma-sub-label">Edit Workflow</div>
                    <select id="kazuma_edit_workflow_list" class="text_pole" style="width:100%; margin-bottom:10px;"></select>
                    
                    <div class="kazuma-sub-label">Input Image</div>
                    
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button id="kazuma_upload_image" class="menu_button" style="flex:1;">
                            <i class="fa-solid fa-upload"></i> Upload Image
                        </button>
                        <button id="kazuma_use_character" class="menu_button" style="flex:1;">
                            <i class="fa-solid fa-user"></i> Use Character
                        </button>
                    </div>
                    
                    <input type="file" id="kazuma_image_file" accept="image/*" style="display:none;" />
                    
                    <div id="kazuma_image_preview" style="display:none; margin-top:10px;">
                        <img id="kazuma_preview_img" style="max-width:100%; border-radius:5px; border:2px solid var(--smart-border-color);" />
                        <button id="kazuma_clear_image" class="menu_button" style="width:100%; margin-top:5px;">
                            <i class="fa-solid fa-xmark"></i> Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Collapsible 1: Image Settings -->
            <details class="kazuma-details" open>
                <summary><i class="fa-solid fa-sliders"></i> Image Parameters</summary>
                <div class="kazuma-content">
                    <div class="kazuma-sub-label">Checkpoint / Model</div>
                    <select id="kazuma_model_list" class="text_pole" style="width:100%"></select>

                    <div class="kazuma-row" style="margin-top:10px;">
                        <span>Sampler</span>
                        <select id="kazuma_sampler_list" class="text_pole" style="width: 60%"></select>
                    </div>

                    <div class="kazuma-row" style="margin-top:5px;">
                        <span>Scheduler</span>
                        <select id="kazuma_scheduler_list" class="text_pole" style="width: 60%"></select>
                    </div>

                    <hr style="opacity:0.2; margin: 10px 0;">

                    <!-- Sliders -->
                    <div class="kazuma-slider-row">
                        <span>Steps</span>
                        <input type="range" id="kazuma_steps" min="1" max="100" />
                        <input type="number" id="kazuma_steps_val" class="text_pole" style="width:50px">
                    </div>

                    <div class="kazuma-slider-row">
                        <span>CFG</span>
                        <input type="range" id="kazuma_cfg" min="1" max="30" step="0.5" />
                        <input type="number" id="kazuma_cfg_val" class="text_pole" style="width:50px">
                    </div>

                    <div class="kazuma-slider-row">
                        <span>Denoise</span>
                        <input type="range" id="kazuma_denoise" min="0" max="1" step="0.05" />
                        <input type="number" id="kazuma_denoise_val" class="text_pole" style="width:50px">
                    </div>

                    <div class="kazuma-slider-row">
                        <span>CLIP</span>
                        <input type="range" id="kazuma_clip" min="1" max="12" step="1" />
                        <input type="number" id="kazuma_clip_val" class="text_pole" style="width:50px">
                    </div>

                    <div class="kazuma-sub-label">Resolution</div>
                    <select id="kazuma_resolution_list" class="text_pole" style="width:100%; margin-bottom:5px;"></select>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="number" id="kazuma_width" class="text_pole" placeholder="W" style="flex:1">
                        <span>x</span>
                        <input type="number" id="kazuma_height" class="text_pole" placeholder="H" style="flex:1">
                    </div>

                     <div class="kazuma-sub-label">Seed (-1 for random)</div>
                    <input type="number" id="kazuma_seed" class="text_pole" style="width:100%">
                </div>
            </details>

            <!-- Collapsible 2: LoRA Lab -->
            <details class="kazuma-details">
                <summary><i class="fa-solid fa-flask"></i> LoRA Lab (4 Slots)</summary>
                <div class="kazuma-content">
                    <div style="display:flex; justify-content:flex-end; margin-bottom:8px;">
                        <button id="kazuma_lora_disable_all" class="menu_button" style="font-size:11px; padding:4px 10px;" title="Disable all LoRAs">
                            <i class="fa-solid fa-power-off"></i> Disable All
                        </button>
                        <button id="kazuma_lora_enable_all" class="menu_button" style="font-size:11px; padding:4px 10px; margin-left:5px;" title="Enable all LoRAs">
                            <i class="fa-solid fa-bolt"></i> Enable All
                        </button>
                    </div>
                    <!-- Slot 1 -->
                    <div class="kazuma-lora-box">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div class="kazuma-sub-label" style="margin:0;">LoRA 1</div>
                            <label style="display:flex; align-items:center; gap:4px; font-size:11px; cursor:pointer;">
                                <input type="checkbox" id="kazuma_lora_on_1" checked /> On
                            </label>
                        </div>
                        <input type="text" class="text_pole kazuma_lora_search" data-target="kazuma_lora_list" placeholder="Search LoRA..." style="width:100%; font-size:11px; padding:3px 6px; margin-bottom:2px;">
                        <select id="kazuma_lora_list" class="text_pole" style="width:100%"></select>
                        <div class="kazuma-slider-row" style="margin-top:5px;">
                            <span>Wt: <span id="kazuma_lora_wt_display">1.0</span></span>
                            <input type="range" id="kazuma_lora_wt" min="-2" max="2" step="0.1">
                        </div>
                    </div>
                    <!-- Slot 2 -->
                     <div class="kazuma-lora-box">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div class="kazuma-sub-label" style="margin:0;">LoRA 2</div>
                            <label style="display:flex; align-items:center; gap:4px; font-size:11px; cursor:pointer;">
                                <input type="checkbox" id="kazuma_lora_on_2" checked /> On
                            </label>
                        </div>
                        <input type="text" class="text_pole kazuma_lora_search" data-target="kazuma_lora_list_2" placeholder="Search LoRA..." style="width:100%; font-size:11px; padding:3px 6px; margin-bottom:2px;">
                        <select id="kazuma_lora_list_2" class="text_pole" style="width:100%"></select>
                        <div class="kazuma-slider-row" style="margin-top:5px;">
                            <span>Wt: <span id="kazuma_lora_wt_display_2">1.0</span></span>
                            <input type="range" id="kazuma_lora_wt_2" min="-2" max="2" step="0.1">
                        </div>
                    </div>
                    <!-- Slot 3 -->
                    <div class="kazuma-lora-box">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div class="kazuma-sub-label" style="margin:0;">LoRA 3</div>
                            <label style="display:flex; align-items:center; gap:4px; font-size:11px; cursor:pointer;">
                                <input type="checkbox" id="kazuma_lora_on_3" checked /> On
                            </label>
                        </div>
                        <input type="text" class="text_pole kazuma_lora_search" data-target="kazuma_lora_list_3" placeholder="Search LoRA..." style="width:100%; font-size:11px; padding:3px 6px; margin-bottom:2px;">
                        <select id="kazuma_lora_list_3" class="text_pole" style="width:100%"></select>
                        <div class="kazuma-slider-row" style="margin-top:5px;">
                            <span>Wt: <span id="kazuma_lora_wt_display_3">1.0</span></span>
                            <input type="range" id="kazuma_lora_wt_3" min="-2" max="2" step="0.1">
                        </div>
                    </div>
                    <!-- Slot 4 -->
                    <div class="kazuma-lora-box">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div class="kazuma-sub-label" style="margin:0;">LoRA 4</div>
                            <label style="display:flex; align-items:center; gap:4px; font-size:11px; cursor:pointer;">
                                <input type="checkbox" id="kazuma_lora_on_4" checked /> On
                            </label>
                        </div>
                        <input type="text" class="text_pole kazuma_lora_search" data-target="kazuma_lora_list_4" placeholder="Search LoRA..." style="width:100%; font-size:11px; padding:3px 6px; margin-bottom:2px;">
                        <select id="kazuma_lora_list_4" class="text_pole" style="width:100%"></select>
                        <div class="kazuma-slider-row" style="margin-top:5px;">
                            <span>Wt: <span id="kazuma_lora_wt_display_4">1.0</span></span>
                            <input type="range" id="kazuma_lora_wt_4" min="-2" max="2" step="0.1">
                        </div>
                    </div>
                </div>
            </details>

            <!-- Negative Prompt -->
            <div class="kazuma-group">
                <div class="kazuma-header">Negative Prompt Override</div>
                <textarea id="kazuma_negative" class="text_pole" rows="2" style="width:100%; font-size:12px; margin-top:5px;"></textarea>
            </div>

            <!-- Manual Action -->
            <div style="display:flex; gap:5px;">
                <button id="kazuma_gen_prompt_btn" class="menu_button" style="flex:1; padding: 10px;">
                    <i class="fa-solid fa-bolt"></i> Visualize Last Message
                </button>
                <button id="kazuma_manual_prompt_btn" class="menu_button" style="padding: 10px;" title="Write your own prompt and send directly to ComfyUI">
                    <i class="fa-solid fa-keyboard"></i>
                </button>
            </div>
        </div>
    </div>
</div>
